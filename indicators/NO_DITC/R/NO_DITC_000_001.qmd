---
title: "Ditches in mires"
format: 
  html:
    embed-resources: true
author:
  - name: Anders Kolstad              # Enter name
    email: anders.kolstad@nina.no  # Enter email
    affiliations:
      - id: myID
        name: Norwegian Institute for Nature Research
date: May 14, 2024 # Enter date 
callout-icon: false
---

```{r source}
#| echo: false
source(here::here("R/_common.R"))
```

<!--# This is a template for how to document the indicator analyses. Make sure also to not change the order, or modify, the headers, unless you really need to. This is because it easier to read if all the indicators are presented using the same layout. If there is one header where you don't have anything to write, just leave the header as is, and dont write anything below it. If you are providing code, Be careful to annotate and comment on every step in the analysis.-->

<!--# INDICATE DEVELOPMENT STATUS. -->
::: {layout-ncol="3"}

```{r}
#| echo: false
#| results: asis
# Hash out the two rows that don't apply to you. As a default, the 'complete' 
# and 'deprecated' options are hashed out, leaving 'incomplete', i.e. saying 
# that the indicator documentation is incomplete, 
#status("complete")
status("incomplete")
#status("deprecated")
```


::: {.callout-note style="background: cornsilk;"}
## Recomended citation

<!--# Here you need to manually enter the recommended citation. Do not remove the ecRxiv name and url, and remember to update the version number -->

Kolstad, A. 2024. Ditches in mires, v.000.001. ecRxiv <https://github.com/NINAnor/ecRxiv-ditches>.
:::

::: {.callout-note style="background: khaki;"}
## Version

<!--# Enter version number below -->

000.001.
:::

:::



<!--# Load all you dependencies here -->

```{r setup}
#| include: false
library(knitr)
library(tidyverse)
library(kableExtra)
library(sf)
library(tmap)
library(ggmagnify)
knitr::opts_chunk$set(echo = TRUE)
```

<!--# Use the IUCN Global Ecosystem Typology (GET) to describe which ecosystem the indicator belongs to. https://doi.org/10.2305/IUCN.CH.2020.13.en. If the indicator covers more than one category in the GET, choose the most prominent one here, and use the text to elaborate on the ecosystem affiliations. -->

```{r GET}
#| echo: false

Realm <- "Terrestrail-Freshwater"
Biome <- "Palustrine wetlands"
EFG   <- "TF1.6 and TF1.7" 
```

<!--# Enter the ecosystem condition typology (ECT) class that your indicator best adheres too (10.3897/oneeco.6.e58218) -->

```{r ECT}
#| echo: false
ECT <- "Physical State Characteristics"
```


```{r tbl}
#| echo: false
#| warning: false
metaData <- tibble(
  Realm,
  Biome,
  EFG, 
  "ECT class" = ECT)
metaData |> 
  t() |>
  as_tibble(rownames = NA) |>
  rownames_to_column() |>
  kbl(col.names = NULL) |>
  kable_classic()

```

# Ditches in mires

_Norwegian name:_ Gr√∏fter i myr

<br />

<!--# Don't remove these three html lines -->

<br /> <br />

<hr />

<!--# Document you work below.  -->

## 1. Introduction

<!--# Describe the indicator in general terms. It is a good idea to include a bullet point list of the spesific steps in the workflow -->

1. **Import data**. A vectorised version of the orignal raster is stored under `data/`.

## 2. About the underlying data

<!--# Describe the data you have used, it's origin, biases, avaiabilit ect.-->

### 2.1 Spatial and temporal resolution

<!--# Describe the temporal and spatial resolution of the data used-->

### 2.2 Original units

<!--# What are the original units for the most relevant  variables in the data-->

### 2.3 Additional comments about the dataset

<!--# Text here -->

## 3. Indicator properties

### 3.1. ECT

<!--# Describe the rationale for assigning the indicator to the ECT class -->

### 3.2. Ecosystem condition characteristic

<!--# Describe the ecosystem condition characteristic represneted in the indicator. See 10.3897/oneeco.6.e58218 for information on what these characteristics might be. -->

### 3.3. Other standards

<!--# Add text about other spesific standards, e.g. natinoal standards, and how the indicator relates to these -->

### 3.4. Collinearities with other indicators

<!--# Describe known collinearities with other metrices (indicators or variables) that could become problematic if they were also included in the same Ecosystem Condition Assessment as the indicator described here. -->

## 4. Reference condition and values

### 4. 1. Reference condition

<!--# Define the reference condition (or refer to where it is defined). Note the destinction between reference condition and reference values 10.3897/oneeco.5.e58216  -->

### 4. 2. Reference values

#### 4.2.1 Minimum and maximum values

<!--# Describe the reference values used to set the lower and upper limits on the normative indicator scale. Why was the current option chosen and how were the reference values quantified? If the reference values are calculated as part of the analyses further down, please repeat the main information here. -->

#### 4.2.2. Threshold value for defining *good ecological condition (if relevant)*

<!--# Describe the different reference values here and the justification for using these -->

#### 4.2.3. Spatial resolution and validity

<!--# Describe the spatial resolution of the reference values. E.g. is it defined as a fixed value for all areas, or does it vary. Also, at what spatial scale is the reference values valid? For example, if the reference value has a regional resolution (varies between regions), it might mean that it is only valid and correct to use for scaling local variable values that are first aggregated to regional scale. However, sometimes the reference value is insensitive to this and can be used to scale variables at the local (e.g. plot) scale.  -->

## 5. Uncertainties

<!--# Describe the main uncertainties or sources of error in the indicator or the underlying data. -->

## 6. References

<!--# You can add references manually or use a citation manager and add intext citations as with crossreferencing and hyperlinks. See https://quarto.org/docs/authoring/footnotes-and-citations.html -->

## 7. Datasets

<!--# Describe the unique datasets seperately under seperate headers (Dataset A, Dataset B, etc.-->

### 7.1 Ditches in Levanger

<!--# Describe the main dataset, typicaly the one containing the variable of (most) interest. Change the header from Dataset A to the name of the actuall dataset. -->
The dataset is created by Vegar Bakkestuen and comes from using LiDAR data (and other input data?) and a deep learning algorithm to detect ditches.
The model is trained on a map of delineated, real ditches in mires (bogs and fens).
The model produces a probability of occurrence for ditches in 1x1 meter grid cells.
I will use a polygon set derived from this raster using a threshold value for probability of ??.
The extent of the data is roughly 10x10 km in Levanger municiapality, Central Norway.
This area was selected as a pilot region for testing the production of this kind of preditcive map of mire ditches.


```{r readDitchata}
ditches <- sf::read_sf("../data/LevangerGroftPolygon.shp")
!any(st_is_valid(ditches))
```

I will use UTM32 as my coordinate reference system (CRS):
```{r myCRS}
myCRS <- 25832
```

```{r firstMap}
#| fig-cap: 'Map of ditches in Levanger. Ditches were automatically identified, mainly from LiDAR, via a deep learning. Ditches have been rutinely dug mires (fens or bogs) in order to lower the water table. Today the areas could be something else, like forest or agriculture.'
#| code-fold: true
#| code-summary: 'Code to produce map'
#| cache: true
  
ditches |>
  ggplot()+
  geom_sf(color = "orange") +
  theme_bw() +
  coord_sf(
    datum = st_crs(myCRS)) +
  ggmagnify::geom_magnify(
    from = c(620000, 621000, 7062000, 7063000), 
    to =   c(623000, 628000, 7060000, 7066000),
    aspect = "fixed",
    shadow =T,
    corners = 0) 
```

### 7.2. Dataset B

<!--# Describe additional datasets in a similar was as above. Deleteor add ned subheaders as needed. -->

## 8. Spatial units

<!--# Describe the spatial units that you rely on in your analyses. Highlight the spatial units (the resolution) that the indicator values should be interpretted at. Potential spatial delineation data should eb introduced under 7.1. Datasets. We recomend using the SEEA EA terminology opf Basic Spatial Units (BSU), Ecosystem Asses (EA) and Ecosystem Accounting Area (EAA). -->

## 9. Analyses

<!--# Use this header for documenting the analyses. Put code in seperate code chunks, and annotate the code in between using normal text (i.e. between the chunks, and try to avoid too many hashed out comments inside the code chunks). Add subheaders as needed. -->

## 10. Results

<!--# Repeat the final results here. Typically this is a map or table of indicator values.-->

## 11. Export file

<!--# Display the code (don't execute it) or the workflow for exporting the indicator values to file. Ideally the indicator values are exported as a georeferenced shape or raster file with indicators values, reference values and errors. You can also chose to export the raw (un-normalised or unscaled variable) as a seperate product. You should not save large sptaial output data on GitHub. You can use eval=FALSE to avoid code from being executed (example below - delete if not relevant) -->

```{r export}
#| eval: false
```
